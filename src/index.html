<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>仪表盘</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;family=Noto+Sans+SC:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#137fec",
            "background-light": "#f6f7f8",
            "background-dark": "#101922",
            "surface-dark": "#1c242d", 
            "surface-light": "#ffffff",
          },
          fontFamily: {
            "display": ["Space Grotesk", "Noto Sans SC", "sans-serif"],
            "body": ["Noto Sans SC", "sans-serif"],
          },
          borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
        },
      },
    }
  </script>
  <style>
    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #374151;
      border-radius: 2px;
    }
    body {
      height: 100vh;
      overflow: hidden;
    }
    .tab-content {
      display: none;
      height: 100%;
      flex-direction: column;
    }
    .tab-content.active {
      display: flex;
    }
    /* 设备控制: 2 行 6 列网格 */
    .compact-grid {
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 0.5rem;
      align-content: start;
    }

    .device-card-30 {
      height: 7rem; /* 相当于 Tailwind 的 h-28 (约 112px) */
    }

    /* 服务监控: 两列卡片网格 */
    .services-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.5rem;
      align-content: start;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 font-body antialiased flex flex-col select-none">
  <!-- Header -->
  <header class="flex-none bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 px-3 py-2 z-20">
      <div class="flex items-center justify-between h-8">
      <!-- Left: Logo/Status Summary -->
      <div class="flex items-center gap-2 text-xs">
         <div class="flex items-center gap-1 text-slate-500 dark:text-slate-400">
            <span class="material-symbols-outlined text-[16px]">memory</span>
            <span id="header-cpu-temp">--°C</span>
         </div>
         <div class="w-px h-3 bg-slate-300 dark:bg-slate-700"></div>
         <div class="flex items-center gap-1 text-slate-500 dark:text-slate-400">
            <span class="material-symbols-outlined text-[16px]">lan</span>
            <span id="header-ip">--</span>
         </div>
      </div>

      <!-- Center: Tabs -->
      <div class="flex bg-slate-200 dark:bg-slate-800 rounded-lg p-1 gap-1">
        <button onclick="switchTab('device')" id="tab-btn-device" class="px-3 py-0.5 rounded-md text-xs font-medium bg-primary text-white shadow-sm transition-all">设备控制</button>
        <button onclick="switchTab('service')" id="tab-btn-service" class="px-3 py-0.5 rounded-md text-xs font-medium text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200 transition-all">服务监控</button>
      </div>

      <!-- Right: Settings -->
      <div class="flex items-center gap-2">
        <button onclick="openAppMenu()" class="p-1 rounded-lg text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">
          <span class="material-symbols-outlined text-[18px]">settings</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content Area -->
  <main class="flex-1 overflow-hidden relative w-full max-w-5xl mx-auto">
    
    <!-- Tab: Device Control -->
    <div id="tab-device" class="tab-content active p-3">
        <div class="flex justify-between items-center mb-2 flex-none">
            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-200">设备列表</h3>
            <button onclick="refreshHaDevices()" class="flex items-center gap-1 px-2 py-1 rounded bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs hover:bg-slate-300 dark:hover:bg-slate-700">
                <span class="material-symbols-outlined text-[14px]">sync</span>
                同步
            </button>
        </div>
        <!-- Devices Grid -->
        <div class="flex-1 overflow-hidden">
             <div id="ha-devices-list" class="compact-grid">
                <!-- Devices will be rendered here -->
                <div class="col-span-full flex flex-col items-center justify-center h-40 text-slate-400 gap-2">
                   <span class="material-symbols-outlined text-3xl animate-spin">sync</span>
                   <p class="text-xs">加载中...</p>
                </div>
             </div>
        </div>
        
        <!-- Pagination Controls -->
        <div class="flex-none pt-2 flex items-center justify-between border-t border-slate-200 dark:border-slate-800 mt-2">
            <button onclick="prevPage('device')" class="p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-30" id="btn-prev-device">
                <span class="material-symbols-outlined text-[18px]">chevron_left</span>
            </button>
            <span class="text-xs text-slate-500" id="page-info-device">1 / 1</span>
            <button onclick="nextPage('device')" class="p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-30" id="btn-next-device">
                <span class="material-symbols-outlined text-[18px]">chevron_right</span>
            </button>
        </div>
    </div>

    <!-- Tab: Service Monitor -->
    <div id="tab-service" class="tab-content p-3">
        <!-- Actions Bar -->
        <div class="flex justify-between items-center mb-2 flex-none">
            <h3 class="text-sm font-bold text-slate-700 dark:text-slate-200">服务列表</h3>
            <div class="flex gap-2">
                <button onclick="openAddServiceModal()" class="flex items-center gap-1 px-2 py-1 rounded bg-primary text-white text-xs hover:bg-primary/90">
                    <span class="material-symbols-outlined text-[14px]">add</span> 添加
                </button>
                <button onclick="refreshAllServices()" class="flex items-center gap-1 px-2 py-1 rounded bg-slate-200 dark:bg-slate-800 text-slate-600 dark:text-slate-300 text-xs hover:bg-slate-300 dark:hover:bg-slate-700">
                    <span class="material-symbols-outlined text-[14px]">refresh</span>
                </button>
            </div>
        </div>

        <!-- Services List -->
        <div class="flex-1 overflow-hidden">
            <div id="services-list" class="services-grid">
                <!-- Services will be rendered here -->
            </div>
        </div>

        <!-- Pagination Controls -->
        <div class="flex-none pt-2 flex items-center justify-between border-t border-slate-200 dark:border-slate-800 mt-2">
            <button onclick="prevPage('service')" class="p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-30" id="btn-prev-service">
                <span class="material-symbols-outlined text-[18px]">chevron_left</span>
            </button>
            <span class="text-xs text-slate-500" id="page-info-service">1 / 1</span>
            <button onclick="nextPage('service')" class="p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-800 disabled:opacity-30" id="btn-next-service">
                <span class="material-symbols-outlined text-[18px]">chevron_right</span>
            </button>
        </div>
    </div>

  </main>

  <!-- Modals -->
  <!-- Add/Edit Service Modal (Compact) -->
  <div id="service-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-surface-light dark:bg-surface-dark rounded-xl w-full max-w-sm shadow-2xl border border-slate-200 dark:border-slate-700">
      <div class="flex items-center justify-between p-3 border-b border-slate-200 dark:border-slate-700">
        <h3 id="modal-title" class="text-sm font-bold text-slate-900 dark:text-white">添加服务</h3>
        <button onclick="closeModal()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300">
          <span class="material-symbols-outlined text-[18px]">close</span>
        </button>
      </div>
      <form id="service-form" onsubmit="saveService(event)" class="p-4 space-y-3">
        <input type="hidden" id="service-id">
        <div class="grid grid-cols-2 gap-3">
            <div class="col-span-2">
              <label class="block text-xs font-medium text-slate-500 mb-1">服务名称</label>
              <input type="text" id="service-name" required class="w-full px-2 py-1.5 rounded bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs focus:ring-1 focus:ring-primary" placeholder="名称">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">IP/主机</label>
              <input type="text" id="service-host" required class="w-full px-2 py-1.5 rounded bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs focus:ring-1 focus:ring-primary" placeholder="192.168.1.1">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">端口</label>
              <input type="number" id="service-port" required class="w-full px-2 py-1.5 rounded bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs focus:ring-1 focus:ring-primary" placeholder="80">
            </div>
            <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">类型</label>
              <select id="service-type" required class="w-full px-2 py-1.5 rounded bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs">
                <option value="web">Web (HTTP)</option>
                <option value="tcp">TCP 端口</option>
              </select>
            </div>
             <div>
              <label class="block text-xs font-medium text-slate-500 mb-1">间隔(秒)</label>
              <input type="number" id="service-interval" value="30" min="5" class="w-full px-2 py-1.5 rounded bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs">
            </div>
        </div>
        
        <div class="flex items-center gap-2">
          <input type="checkbox" id="service-enabled" checked class="rounded text-primary focus:ring-primary w-4 h-4">
          <label for="service-enabled" class="text-xs text-slate-700 dark:text-slate-300">启用监控</label>
        </div>

        <div class="flex gap-2 pt-2">
          <button type="button" onclick="closeModal()" class="flex-1 py-1.5 rounded bg-slate-100 dark:bg-slate-800 text-xs font-medium hover:bg-slate-200 dark:hover:bg-slate-700">取消</button>
          <button type="submit" class="flex-1 py-1.5 rounded bg-primary text-white text-xs font-medium hover:bg-primary/90">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Service Context Menu -->
  <div id="service-menu" class="fixed inset-0 bg-black/20 z-50 hidden" onclick="if(event.target===this) closeServiceMenu()">
     <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 p-1 w-32">
        <button onclick="menuCheckService()" class="w-full text-left px-3 py-2 text-xs hover:bg-slate-100 dark:hover:bg-slate-700 rounded flex items-center gap-2">
            <span class="material-symbols-outlined text-[14px]">refresh</span> 刷新
        </button>
        <button onclick="menuEditService()" class="w-full text-left px-3 py-2 text-xs hover:bg-slate-100 dark:hover:bg-slate-700 rounded flex items-center gap-2">
            <span class="material-symbols-outlined text-[14px]">edit</span> 编辑
        </button>
        <button onclick="menuDeleteService()" class="w-full text-left px-3 py-2 text-xs hover:bg-red-50 dark:hover:bg-red-900/30 text-red-600 rounded flex items-center gap-2">
            <span class="material-symbols-outlined text-[14px]">delete</span> 删除
        </button>
     </div>
  </div>

  <div id="app-menu" class="fixed inset-0 bg-black/20 z-50 hidden" onclick="if(event.target===this) closeAppMenu()">
     <div class="absolute top-10 right-3 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 p-1 w-40">
        <button onclick="menuOpenHaSettings()" class="w-full text-left px-3 py-2 text-xs hover:bg-slate-100 dark:hover:bg-slate-700 rounded flex items-center gap-2">
            <span class="material-symbols-outlined text-[14px]">tune</span> HA 设置
        </button>
        <button onclick="menuToggleFullscreen()" class="w-full text-left px-3 py-2 text-xs hover:bg-slate-100 dark:hover:bg-slate-700 rounded flex items-center gap-2">
            <span class="material-symbols-outlined text-[14px]">fullscreen</span> 切换全屏
        </button>
        <button onclick="menuQuitApp()" class="w-full text-left px-3 py-2 text-xs hover:bg-red-50 dark:hover:bg-red-900/30 text-red-600 rounded flex items-center gap-2">
            <span class="material-symbols-outlined text-[14px]">power_settings_new</span> 退出程序
        </button>
     </div>
  </div>

  <div id="device-menu" class="fixed inset-0 bg-black/20 z-50 hidden" onclick="if(event.target===this) closeDeviceMenu()">
     <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-slate-800 rounded-lg shadow-xl border border-slate-200 dark:border-slate-700 p-1 w-32">
        <button onclick="menuExcludeDevice()" class="w-full text-left px-3 py-2 text-xs hover:bg-slate-100 dark:hover:bg-slate-700 rounded flex items-center gap-2">
            <span class="material-symbols-outlined text-[14px]">block</span> 排除设备
        </button>
     </div>
  </div>

  <!-- HA Settings Modal -->
  <div id="ha-settings-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-surface-light dark:bg-surface-dark rounded-xl w-full max-w-sm p-4 shadow-2xl border border-slate-200 dark:border-slate-700 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-base font-bold text-slate-900 dark:text-white">设置</h3>
        <button onclick="closeHaSettings()" class="p-1 rounded text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800">
          <span class="material-symbols-outlined text-[18px]">close</span>
        </button>
      </div>
      
      <!-- Tabs -->
      <div class="flex border-b border-slate-200 dark:border-slate-700 mb-4">
          <button onclick="switchSettingsTab('ha')" id="tab-btn-ha" class="flex-1 pb-2 text-xs font-medium text-primary border-b-2 border-primary">Home Assistant</button>
          <button onclick="switchSettingsTab('temp')" id="tab-btn-temp" class="flex-1 pb-2 text-xs font-medium text-slate-500 dark:text-slate-400">温度阈值</button>
      </div>

      <form id="settings-form-ha" onsubmit="saveHaSettings(event)" class="space-y-3">
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">HA 地址</label>
          <input type="url" id="ha-url" class="w-full px-2 py-1.5 rounded bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs focus:ring-1 focus:ring-primary" placeholder="http://192.168.x.x:8123">
        </div>
        <div>
          <label class="block text-xs font-medium text-slate-500 mb-1">Token</label>
          <input type="password" id="ha-token" class="w-full px-2 py-1.5 rounded bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-xs focus:ring-1 focus:ring-primary" placeholder="Long-lived access token">
        </div>
        <div>
          <div class="flex items-center justify-between mb-1">
            <label class="block text-xs font-medium text-slate-500">排除设备</label>
            <span class="text-[10px] text-slate-400">点击恢复以重新显示</span>
          </div>
          <div id="excluded-devices-list" class="max-h-32 overflow-auto border border-slate-200 dark:border-slate-700 rounded px-2 py-1 bg-slate-50 dark:bg-slate-900 text-[11px] space-y-1"></div>
        </div>
        <div class="pt-1">
            <button type="button" onclick="testHaConnection()" id="btn-test-ha" class="w-full py-1.5 rounded border border-slate-200 dark:border-slate-700 text-xs hover:bg-slate-50 dark:hover:bg-slate-800 mb-2">测试连接</button>
            <button type="submit" class="w-full py-1.5 rounded bg-primary text-white text-xs font-medium hover:bg-primary/90">保存配置</button>
        </div>
      </form>

      <form id="settings-form-temp" onsubmit="saveTempSettings(event)" class="space-y-4 hidden">
        <div>
           <div class="flex justify-between mb-1">
            <label class="text-xs text-slate-500">警告 (橙色)</label>
            <span class="text-xs font-bold text-orange-500"><span id="temp-orange-val">60</span>°C</span>
           </div>
           <input type="range" id="temp-orange" min="40" max="90" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-orange-500" oninput="updateRangeValue('temp-orange-val', this.value)">
        </div>
        <div>
           <div class="flex justify-between mb-1">
            <label class="text-xs text-slate-500">危险 (红色)</label>
            <span class="text-xs font-bold text-red-500"><span id="temp-red-val">80</span>°C</span>
           </div>
           <input type="range" id="temp-red" min="50" max="100" class="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-red-500" oninput="updateRangeValue('temp-red-val', this.value)">
        </div>
        <button type="submit" class="w-full py-1.5 rounded bg-primary text-white text-xs font-medium hover:bg-primary/90 mt-2">保存阈值</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { invoke } from '@tauri-apps/api/core';

    const state = {
        services: [],
        serviceStatuses: {},
        devices: [],
        rawDevices: [],
        appConfig: {
            temp_threshold_orange: 60,
            temp_threshold_red: 80
        },
        currentServiceId: null,
        currentDeviceId: null,
        pagination: {
            device: { page: 1, pageSize: 12, total: 0 },
            service: { page: 1, pageSize: 5, total: 0 }
        },
        excludedEntities: []
    };

    const serviceNextCheck = {};
    let servicePollTimer = null;

    // --- Tab Management ---
    window.switchTab = function(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Update Buttons
        const btnDevice = document.getElementById('tab-btn-device');
        const btnService = document.getElementById('tab-btn-service');
        
        if (tabName === 'device') {
            btnDevice.className = 'px-3 py-0.5 rounded-md text-xs font-medium bg-primary text-white shadow-sm transition-all';
            btnService.className = 'px-3 py-0.5 rounded-md text-xs font-medium text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200 transition-all';
        } else {
            btnService.className = 'px-3 py-0.5 rounded-md text-xs font-medium bg-primary text-white shadow-sm transition-all';
            btnDevice.className = 'px-3 py-0.5 rounded-md text-xs font-medium text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200 transition-all';
            loadServices(); // Refresh services when switching
        }
    };

    // --- Pagination Logic ---
    function updatePagination(type) {
        const { page, pageSize, total } = state.pagination[type];
        const totalPages = Math.ceil(total / pageSize) || 1;
        
        document.getElementById(`page-info-${type}`).textContent = `${page} / ${totalPages}`;
        document.getElementById(`btn-prev-${type}`).disabled = page <= 1;
        document.getElementById(`btn-next-${type}`).disabled = page >= totalPages;
    }

    window.prevPage = function(type) {
        if (state.pagination[type].page > 1) {
            state.pagination[type].page--;
            if (type === 'device') renderDevices();
            else renderServicesList();
        }
    };

    window.nextPage = function(type) {
        const totalPages = Math.ceil(state.pagination[type].total / state.pagination[type].pageSize);
        if (state.pagination[type].page < totalPages) {
            state.pagination[type].page++;
            if (type === 'device') renderDevices();
            else renderServicesList();
        }
    };

    // --- Initialization ---
    async function init() {
        await loadConfig();
        
        // Start Loops
        updateSystemInfo();
        setInterval(updateSystemInfo, 2000);

        updateLocalIp();
        setInterval(updateLocalIp, 10000);
        
        refreshHaDevices(); // Initial load
        // setInterval(refreshHaDevices, 10000); // Optional auto-refresh
    }
    
    // --- System Info & Header ---
    async function updateSystemInfo() {
      try {
        const info = await invoke('get_system_info');
        const cpuTemp = info.cpu_temp;
        const el = document.getElementById('header-cpu-temp');
        if (cpuTemp) {
            el.textContent = Math.round(cpuTemp) + '°C';
            // Color logic
            if (cpuTemp >= state.appConfig.temp_threshold_red) el.className = 'text-red-500 font-bold';
            else if (cpuTemp >= state.appConfig.temp_threshold_orange) el.className = 'text-orange-500 font-medium';
            else el.className = '';
        }
      } catch (e) { console.error(e); }
    }

    async function updateLocalIp() {
      try {
        const ip = await invoke('get_local_ip');
        document.getElementById('header-ip').textContent = ip;
      } catch (e) { console.error(e); }
    }

    // --- Device Control ---
    window.refreshHaDevices = async function() {
        const container = document.getElementById('ha-devices-list');
        if (!state.appConfig.ha_url || !state.appConfig.ha_token) {
             container.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center h-40 text-slate-400 gap-2 cursor-pointer hover:text-primary transition-colors" onclick="openHaSettings()">
                    <span class="material-symbols-outlined text-3xl">settings_suggest</span>
                    <p class="text-xs">点击配置 Home Assistant</p>
                </div>`;
             return;
        }

        try {
            const entities = await invoke('get_ha_entities');
            state.rawDevices = entities.filter(e => 
                e.entity_id.startsWith('light.') || 
                e.entity_id.startsWith('switch.') ||
                e.entity_id.startsWith('fan.') ||
                e.entity_id.startsWith('cover.')
            );
            const excluded = new Set(state.excludedEntities || []);
            state.devices = state.rawDevices.filter(e => !excluded.has(e.entity_id));
            
            state.pagination.device.total = state.devices.length;
            // Reset page if out of bounds
            const totalPages = Math.ceil(state.devices.length / state.pagination.device.pageSize) || 1;
            if (state.pagination.device.page > totalPages) state.pagination.device.page = 1;

            renderDevices();
        } catch (error) {
            console.error(error);
            container.innerHTML = `<div class="col-span-full text-center text-red-500 text-xs py-10">连接失败: ${error}</div>`;
        }
    };

    window.openAppMenu = function() {
        document.getElementById('app-menu').classList.remove('hidden');
    };

    window.closeAppMenu = function() {
        document.getElementById('app-menu').classList.add('hidden');
    };

    window.menuOpenHaSettings = function() {
        closeAppMenu();
        openHaSettings();
    };

    window.menuToggleFullscreen = async function() {
        try {
            await invoke('toggle_fullscreen_cmd');
        } catch (e) {
            console.error(e);
        }
    };

    window.menuQuitApp = async function() {
        try {
            await invoke('quit_app_cmd');
        } catch (e) {
            console.error(e);
        }
    };

    function renderDevices() {
        const container = document.getElementById('ha-devices-list');
        container.innerHTML = '';
        
        const { page, pageSize } = state.pagination.device;
        const start = (page - 1) * pageSize;
        const pageDevices = state.devices.slice(start, start + pageSize);

        if (pageDevices.length === 0) {
            container.innerHTML = `<div class="col-span-full text-center text-slate-400 text-xs py-10">未找到设备</div>`;
        } else {
            pageDevices.forEach(device => {
                const isOn = device.state === 'on';
                const name = device.attributes.friendly_name || device.entity_id;
                let icon = 'toggle_off';
                if (device.entity_id.startsWith('light.')) icon = 'lightbulb';
                else if (device.entity_id.startsWith('fan.')) icon = 'mode_fan';
                else if (device.entity_id.startsWith('cover.')) icon = 'blinds';
                
                const div = document.createElement('div');
                div.className = `relative flex flex-col items-center justify-center p-2 rounded-lg border transition-all cursor-pointer device-card-30 ${
                    isOn 
                    ? 'bg-primary/10 border-primary/30 text-primary' 
                    : 'bg-surface-light dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 hover:border-slate-300'
                }`;
                div.onclick = () => toggleHaDevice(device.entity_id);
                
                div.innerHTML = `
                    <button class="absolute top-1 right-1 p-0.5 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-400" onclick="event.stopPropagation(); openDeviceMenu('${device.entity_id}')">
                        <span class="material-symbols-outlined text-[14px]">more_vert</span>
                    </button>
                    <span class="material-symbols-outlined text-2xl mb-1 ${isOn ? 'fill-current' : ''}">${icon}</span>
                    <span class="text-[10px] font-medium truncate w-full text-center leading-tight">${name}</span>
                    <span class="text-[9px] opacity-70">${isOn ? '开启' : '关闭'}</span>
                `;
                container.appendChild(div);
            });
        }
        updatePagination('device');
    }

    window.toggleHaDevice = async function(entityId) {
        const device = state.devices.find(d => d.entity_id === entityId);
        if (!device) return;
        
        const domain = entityId.split('.')[0];
        const service = device.state === 'on' ? 'turn_off' : 'turn_on';
        
        // Optimistic update
        const originalState = device.state;
        device.state = service === 'turn_on' ? 'on' : 'off';
        renderDevices();

        try {
            await invoke('call_ha_service', { domain, service, entityId });
            // Background refresh to confirm
            setTimeout(refreshHaDevices, 500);
        } catch (e) {
            // Revert
            device.state = originalState;
            renderDevices();
            alert('操作失败: ' + e);
        }
    };

    window.excludeDevice = async function(entityId) {
        if (!confirm('将此设备从控制页中排除？')) return;
        if (!state.excludedEntities.includes(entityId)) {
            state.excludedEntities.push(entityId);
        }
        const newConfig = { ...state.appConfig, excluded_entities: state.excludedEntities };
        try {
            await invoke('update_app_config', { config: newConfig });
            state.appConfig = newConfig;
            await refreshHaDevices();
            renderExcludedDevices();
        } catch (err) {
            alert(err);
        }
    };

    // --- Services ---
    async function loadServices() {
        try {
            state.services = await invoke('get_services');
            state.pagination.service.total = state.services.length;
             // Reset page if out of bounds
            const totalPages = Math.ceil(state.services.length / state.pagination.service.pageSize) || 1;
            if (state.pagination.service.page > totalPages) state.pagination.service.page = 1;

            renderServicesList();
            refreshAllServices();
            resetServiceSchedule();
            startServicePolling();
        } catch (e) { console.error(e); }
    }

    function renderServicesList() {
        const container = document.getElementById('services-list');
        container.innerHTML = '';
        
        const { page, pageSize } = state.pagination.service;
        const start = (page - 1) * pageSize;
        const pageServices = state.services.slice(start, start + pageSize);

        if (pageServices.length === 0) {
             container.innerHTML = `<div class="text-center text-slate-400 text-xs py-8">暂无服务</div>`;
        } else {
            pageServices.forEach(service => {
                const status = state.serviceStatuses[service.id];
                const isOnline = status ? status.is_online : false;
                const responseTime = status ? status.response_time : 0;
                
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 rounded bg-surface-light dark:bg-slate-800 border border-slate-200 dark:border-slate-700 cursor-pointer hover:border-primary/50 transition-colors';
                div.onclick = () => showServiceMenu(service.id);
                
                div.innerHTML = `
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-2 h-2 rounded-full flex-none ${isOnline ? 'bg-emerald-500' : 'bg-red-500'}"></div>
                        <div class="flex flex-col overflow-hidden">
                            <span class="text-xs font-bold truncate text-slate-700 dark:text-slate-200">${service.name}</span>
                            <span class="text-[10px] text-slate-400 truncate">${service.host}:${service.port}</span>
                        </div>
                    </div>
                    <span class="text-[10px] font-mono ${isOnline ? 'text-emerald-600' : 'text-red-500'} flex-none ml-2">
                        ${isOnline ? responseTime + 'ms' : 'OFFLINE'}
                    </span>
                `;
                container.appendChild(div);
            });
        }
        updatePagination('service');
    }

    window.refreshAllServices = async function() {
        try {
            const statuses = await invoke('get_all_status');
            statuses.forEach(s => state.serviceStatuses[s.service_id] = s);
            renderServicesList();
        } catch (e) { console.error(e); }
    };

    function resetServiceSchedule() {
        for (const key in serviceNextCheck) delete serviceNextCheck[key];
        const now = Date.now();
        state.services.forEach(s => {
            if (s.enabled) serviceNextCheck[s.id] = now;
        });
    }

    function startServicePolling() {
        if (servicePollTimer) return;
        servicePollTimer = setInterval(() => {
            tickServicePolling().catch(console.error);
        }, 1000);
    }

    async function tickServicePolling() {
        const now = Date.now();
        const services = state.services.filter(s => s.enabled && s.check_interval && s.check_interval > 0);
        let updated = false;
        for (const service of services) {
            const intervalMs = service.check_interval * 1000;
            const next = serviceNextCheck[service.id] ?? 0;
            if (now >= next) {
                try {
                    const status = await invoke('check_service', { id: service.id });
                    state.serviceStatuses[status.service_id] = status;
                } catch (e) {
                    state.serviceStatuses[service.id] = {
                        service_id: service.id,
                        is_online: false,
                        response_time: 0,
                        last_checked: new Date().toISOString(),
                        error_message: String(e)
                    };
                }
                serviceNextCheck[service.id] = now + intervalMs;
                updated = true;
            }
        }
        if (updated) renderServicesList();
    }
    
    // --- Config & Modals ---
    async function loadConfig() {
        try {
            state.appConfig = await invoke('get_app_config');
            state.excludedEntities = state.appConfig.excluded_entities || [];
        } catch (e) { console.error(e); }
    }

    // --- Service Menu & Modal Actions ---
    window.openAddServiceModal = function() {
        document.getElementById('modal-title').textContent = '添加服务';
        document.getElementById('service-form').reset();
        document.getElementById('service-id').value = '';
        document.getElementById('service-modal').classList.remove('hidden');
    };
    
    window.closeModal = function() {
        document.getElementById('service-modal').classList.add('hidden');
    };
    
    window.saveService = async function(event) {
        event.preventDefault();
        const id = document.getElementById('service-id').value || 'service-' + Date.now();
        const service = {
            id,
            name: document.getElementById('service-name').value,
            service_type: document.getElementById('service-type').value,
            host: document.getElementById('service-host').value,
            port: parseInt(document.getElementById('service-port').value),
            check_interval: parseInt(document.getElementById('service-interval').value),
            enabled: document.getElementById('service-enabled').checked
        };
        
        try {
            if (document.getElementById('service-id').value) await invoke('update_service', { id, service });
            else await invoke('add_service', { service });
            closeModal();
            loadServices();
        } catch (e) { alert(e); }
    };

    window.showServiceMenu = function(id) {
        state.currentServiceId = id;
        document.getElementById('service-menu').classList.remove('hidden');
    };
    
    window.closeServiceMenu = function() {
        document.getElementById('service-menu').classList.add('hidden');
    };
    
    window.menuEditService = function() {
        const service = state.services.find(s => s.id === state.currentServiceId);
        if (service) {
             document.getElementById('modal-title').textContent = '编辑服务';
             document.getElementById('service-id').value = service.id;
             document.getElementById('service-name').value = service.name;
             document.getElementById('service-host').value = service.host;
             document.getElementById('service-port').value = service.port;
             document.getElementById('service-type').value = service.service_type;
             document.getElementById('service-interval').value = service.check_interval;
             document.getElementById('service-enabled').checked = service.enabled;
             document.getElementById('service-modal').classList.remove('hidden');
        }
        closeServiceMenu();
    };

    window.menuDeleteService = async function() {
        if(confirm('删除此服务？')) {
            try {
                await invoke('delete_service', { id: state.currentServiceId });
                loadServices();
            } catch(e) { alert(e); }
        }
        closeServiceMenu();
    };

    window.menuCheckService = async function() {
        try {
            const status = await invoke('check_service', { id: state.currentServiceId });
            state.serviceStatuses[status.service_id] = status;
            renderServicesList();
        } catch(e) { console.error(e); }
        closeServiceMenu();
    };

    // --- HA Settings ---
    window.openHaSettings = async function() {
        await loadConfig();
        document.getElementById('ha-url').value = state.appConfig.ha_url || '';
        document.getElementById('ha-token').value = state.appConfig.ha_token || '';
        document.getElementById('temp-orange').value = state.appConfig.temp_threshold_orange;
        document.getElementById('temp-orange-val').textContent = state.appConfig.temp_threshold_orange;
        document.getElementById('temp-red').value = state.appConfig.temp_threshold_red;
        document.getElementById('temp-red-val').textContent = state.appConfig.temp_threshold_red;
        
        switchSettingsTab('ha');
        renderExcludedDevices();
        document.getElementById('ha-settings-modal').classList.remove('hidden');
    };
    
    window.closeHaSettings = () => document.getElementById('ha-settings-modal').classList.add('hidden');
    
    window.switchSettingsTab = function(tab) {
        const haForm = document.getElementById('settings-form-ha');
        const tempForm = document.getElementById('settings-form-temp');
        const haBtn = document.getElementById('tab-btn-ha');
        const tempBtn = document.getElementById('tab-btn-temp');
        
        if (tab === 'ha') {
            haForm.classList.remove('hidden');
            tempForm.classList.add('hidden');
            haBtn.className = 'flex-1 pb-2 text-xs font-medium text-primary border-b-2 border-primary';
            tempBtn.className = 'flex-1 pb-2 text-xs font-medium text-slate-500 dark:text-slate-400';
        } else {
            haForm.classList.add('hidden');
            tempForm.classList.remove('hidden');
            tempBtn.className = 'flex-1 pb-2 text-xs font-medium text-primary border-b-2 border-primary';
            haBtn.className = 'flex-1 pb-2 text-xs font-medium text-slate-500 dark:text-slate-400';
        }
    };
    
    window.saveHaSettings = async function(e) {
        e.preventDefault();
        const newConfig = { ...state.appConfig, ha_url: document.getElementById('ha-url').value, ha_token: document.getElementById('ha-token').value, excluded_entities: state.excludedEntities };
        try {
            await invoke('update_app_config', { config: newConfig });
            closeHaSettings();
            refreshHaDevices();
        } catch(err) { alert(err); }
    };
    
    window.saveTempSettings = async function(e) {
        e.preventDefault();
        const newConfig = { ...state.appConfig, temp_threshold_orange: parseFloat(document.getElementById('temp-orange').value), temp_threshold_red: parseFloat(document.getElementById('temp-red').value) };
        try {
            await invoke('update_app_config', { config: newConfig });
            closeHaSettings();
            updateSystemInfo();
        } catch(err) { alert(err); }
    };

    window.updateRangeValue = (id, val) => document.getElementById(id).textContent = val;

    window.testHaConnection = async function() {
        const url = document.getElementById('ha-url').value;
        const token = document.getElementById('ha-token').value;
        const btn = document.getElementById('btn-test-ha');
        if(!url || !token) { alert('请填写完整'); return; }
        
        const oldText = btn.innerText;
        btn.disabled = true;
        btn.innerText = '连接中...';
        try {
            await invoke('check_ha_connection', { url, token });
            btn.innerText = '成功!';
            setTimeout(() => { btn.disabled = false; btn.innerText = oldText; }, 1500);
        } catch(e) {
            alert(e);
            btn.disabled = false;
            btn.innerText = oldText;
        }
    };

    window.openDeviceMenu = function(entityId) {
        state.currentDeviceId = entityId;
        document.getElementById('device-menu').classList.remove('hidden');
    };

    window.closeDeviceMenu = function() {
        state.currentDeviceId = null;
        document.getElementById('device-menu').classList.add('hidden');
    };

    window.menuExcludeDevice = function() {
        if (!state.currentDeviceId) return;
        excludeDevice(state.currentDeviceId);
        closeDeviceMenu();
    };

    function renderExcludedDevices() {
        const container = document.getElementById('excluded-devices-list');
        if (!container) return;
        const ids = state.appConfig.excluded_entities || state.excludedEntities || [];
        container.innerHTML = '';
        if (!ids.length) {
            container.textContent = '当前没有排除的设备';
            return;
        }
        ids.forEach(id => {
            const device = (state.rawDevices || []).find(d => d.entity_id === id);
            const name = device && device.attributes && device.attributes.friendly_name ? device.attributes.friendly_name : id;
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between gap-2';
            row.innerHTML = `
                <span class="truncate">${name}</span>
                <button class="px-2 py-0.5 rounded bg-slate-200 dark:bg-slate-800 text-[10px]" data-id="${id}">恢复</button>
            `;
            row.querySelector('button').onclick = () => includeDevice(id);
            container.appendChild(row);
        });
    }

    function includeDevice(entityId) {
        state.excludedEntities = (state.excludedEntities || []).filter(id => id !== entityId);
        const newConfig = { ...state.appConfig, excluded_entities: state.excludedEntities };
        invoke('update_app_config', { config: newConfig })
            .then(() => {
                state.appConfig = newConfig;
                renderExcludedDevices();
                refreshHaDevices();
            })
            .catch(err => alert(err));
    }

    init();
  </script>
</body>
</html>
